<!-- 
  ã€å­¸è¯èªå‘å‰èµ° Book 2 - å…¨ç”Ÿè©æŒ‘æˆ°ç‰ˆã€‘
  ç‰ˆæœ¬ï¼š2025-Book2-CounterFinal
  
  æ›´æ–°æ—¥èªŒï¼š
  1. [Fix] ç´¯ç©äººæ¬¡é‚è¼¯ä¿®æ­£ï¼š
     - åœ¨æœ¬æ©Ÿ/é è¦½ç’°å¢ƒä¸‹ï¼Œè¨­å®šå®Œæç¤ºæ–‡å­—å¾Œç›´æ¥ returnï¼Œé¿å…å¾ŒçºŒå˜—è©¦é€£ç·šé€ æˆéŒ¯èª¤è¦†è“‹ã€‚
     - å¼·åˆ¶ä½¿ç”¨ https å”å®šè¼‰å…¥è¨ˆæ•¸å™¨è…³æœ¬ï¼Œæé«˜ç›¸å®¹æ€§ã€‚
  2. [System] é€™æ˜¯åŒ…å«æ‰€æœ‰åŠŸèƒ½ (Wake Lock, Copy Result, Custom Words, Styles) çš„æœ€çµ‚å®Œæ•´ç‰ˆã€‚
-->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿè©å¤§æŒ‘æˆ°</title>
</head>
<body style="margin:0; padding:0;">

<!-- 1. è¨­å®šæ›è¼‰é» -->
<div id="huayu-book2-root" style="width: 100%; min-height: 600px; margin: 0 auto; position: relative; z-index: 1;"></div>

<!-- 2. éŠæˆ²æ ¸å¿ƒé‚è¼¯ -->
<script type="module">
    (function() {
        'use strict';

        // --- å•Ÿå‹•æ©Ÿåˆ¶ ---
        function bootstrapGame() {
            const rootId = 'huayu-book2-root';
            let attempts = 0;
            const maxAttempts = 60;
            
            const checkExist = setInterval(function() {
                const root = document.getElementById(rootId);
                attempts++;

                if (root) {
                    clearInterval(checkExist);
                    if (root.getAttribute('data-initialized') === 'true') return;
                    root.setAttribute('data-initialized', 'true');
                    initGameSystem(root);
                } else {
                    if (attempts >= maxAttempts) {
                        console.warn("Root container not found.");
                        clearInterval(checkExist);
                    }
                }
            }, 500);
        }

        function initGameSystem(root) {
            // --- 1. Shadow DOM åˆå§‹åŒ– ---
            let shadow;
            try {
                if (root.shadowRoot) {
                    shadow = root.shadowRoot;
                    shadow.innerHTML = ''; 
                } else {
                    shadow = root.attachShadow({ mode: 'open' });
                }
            } catch (e) {
                console.error("Shadow DOM Error:", e);
                return;
            }

            // --- 2. PWA Meta Tags ---
            try {
                if (!document.querySelector('meta[name="apple-mobile-web-app-capable"]')) {
                    const meta1 = document.createElement('meta'); meta1.name = "apple-mobile-web-app-capable"; meta1.content = "yes";
                    document.head.appendChild(meta1);
                    const meta2 = document.createElement('meta'); meta2.name = "apple-mobile-web-app-status-bar-style"; meta2.content = "black-translucent";
                    document.head.appendChild(meta2);
                    const meta3 = document.createElement('meta'); meta3.name = "theme-color"; meta3.content = "#F0FDF4";
                    document.head.appendChild(meta3);
                }
            } catch(e) {}

            // --- 3. æ¨£å¼å®šç¾© (Green Theme) ---
            const styles = `
                :host { all: initial; display: block; font-family: system-ui, -apple-system, sans-serif; }
                * { box-sizing: border-box; }
                
                .game-container { background-color: #F0FDF4; color: #164E33; min-height: 100vh; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
                .inner-wrapper { width: 100%; max-width: 550px; margin: 0 auto; display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; border-radius: 1rem; }
                
                header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
                .title-group { display: flex; align-items: center; gap: 0.75rem; }
                h1 { font-size: 1.25rem; font-weight: 700; color: #064E3B; margin: 0; line-height: 1.2; }
                .subtitle { font-size: 0.75rem; color: #059669; font-weight: 500; }
                
                .header-actions { display: flex; gap: 0.5rem; }
                
                button.icon-btn { padding: 0.5rem; border-radius: 9999px; border: none; background: transparent; color: #059669; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; justify-content: center; }
                button.icon-btn:hover { background-color: #D1FAE5; }
                
                /* Controls å€åŸŸå„ªåŒ–ï¼šæ”¹ç”¨ flex-end å°é½Šåº•éƒ¨ */
                .controls { padding: 0.5rem 0.75rem; border-radius: 0.75rem; background-color: #ECFDF5; border: 1px solid #6EE7B7; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: flex-end; gap: 8px; }
                
                .select-wrapper { flex: 1; display: flex; flex-direction: column; }
                .select-label { font-size: 0.75rem; font-weight: 500; margin-bottom: 0.25rem; opacity: 0.7; color: #064E3B; }
                
                /* Select æ¨£å¼å„ªåŒ–ï¼šå¼·åˆ¶é«˜åº¦èˆ‡å–®ç®­é ­ */
                select { 
                    width: 100%; 
                    height: 38px; /* å¼·åˆ¶é«˜åº¦ */
                    padding: 0 2rem 0 0.75rem; /* ç§»é™¤å‚ç›´ padding æ”¹ç”¨ height æ§åˆ¶ */
                    border-radius: 0.5rem; 
                    border: 1px solid #6EE7B7; 
                    background-color: white; 
                    color: #064E3B; 
                    font-size: 0.875rem; 
                    outline: none; 
                    appearance: none; 
                    -webkit-appearance: none;
                    -moz-appearance: none;
                    /* å‘ä¸‹å–®ç®­é ­ (Chevron Down) */
                    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23059669' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                    background-repeat: no-repeat;
                    background-position: right 0.5rem center;
                    background-size: 1rem;
                    cursor: pointer;
                    line-height: 1.3;
                }
                
                .refresh-btn { 
                    padding: 0; 
                    border-radius: 0.5rem; 
                    background-color: white; 
                    color: #059669; 
                    border: 1px solid #6EE7B7; 
                    cursor: pointer; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    height: 38px; /* å¼·åˆ¶é«˜åº¦ */
                    width: 38px; 
                    flex-shrink: 0; 
                }
                .refresh-btn:hover { background-color: #D1FAE5; }
                
                /* è¨ˆæ™‚å™¨æ¨£å¼ */
                .timer-badge {
                    background-color: white;
                    color: #059669;
                    border: 1px solid #6EE7B7;
                    border-radius: 0.5rem;
                    padding: 0 12px;
                    height: 38px; /* å¼·åˆ¶é«˜åº¦ */
                    display: flex;
                    align-items: center;
                    font-weight: 700;
                    font-family: monospace;
                    font-size: 1rem;
                    white-space: nowrap;
                }

                .game-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; width: 100%; }
                .grid-container { 
                    background-color: white; 
                    padding: 0.5rem; 
                    border-radius: 1.25rem; 
                    border: 2px solid #6EE7B7; 
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
                    user-select: none; 
                    display: grid; 
                    gap: 2px; 
                    margin-bottom: 1rem; 
                    width: 100%; 
                }
                
                .cell { 
                    width: 100%; 
                    aspect-ratio: 1; 
                    display: flex; align-items: center; justify-content: center; 
                    font-size: clamp(0.8rem, 3.5vw, 1.2rem); 
                    font-weight: 500; 
                    border-radius: 0.25rem; 
                    cursor: pointer; 
                    transition: all 0.2s ease; 
                    background-color: white; color: #374151; 
                    border: 2px solid transparent; 
                }
                
                .cell.active-start { background-color: #10B981 !important; color: white !important; transform: scale(0.95); box-shadow: inset 0 0 0 2px #6EE7B7; z-index: 5; }
                .cell.found { background-color: #059669 !important; color: white !important; border-color: #D1FAE5; animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
                .cell:hover { background-color: #D1FAE5; }
                
                .modal-overlay { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background-color: rgba(240, 253, 244, 0.9); backdrop-filter: blur(4px); border-radius: 0.75rem; }
                .modal-overlay.show { display: flex; }
                
                /* å±¤ç´šè¨­å®š */
                #start-modal { z-index: 10; }
                #victory-modal { z-index: 20; }
                #custom-modal { z-index: 90; }
                #install-modal { z-index: 100; }

                .modal-content { background-color: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border: 2px solid #6EE7B7; text-align: center; width: 85%; max-width: 320px; position: relative;}
                .modal-close-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.2rem; color: #999; cursor: pointer; }
                .modal-btn { padding: 0.5rem 1.5rem; border-radius: 9999px; background-color: #10B981; color: white; font-weight: 500; border: none; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 1rem; transition: transform 0.1s;}
                .modal-btn:hover { background-color: #059669; transform: scale(1.05); }
                .modal-btn:active { transform: scale(0.95); }

                .modal-btn.danger { background-color: #EF4444; margin-top: 0.5rem; }
                .modal-btn.danger:hover { background-color: #DC2626; }
                /* åˆªé™¤ç¢ºèªç‹€æ…‹ */
                .modal-btn.danger.confirming { background-color: #991B1B; animation: pulse 1s infinite; }
                
                .modal-btn.secondary { background-color: #9CA3AF; margin-top: 0.5rem; }
                .modal-btn.secondary:hover { background-color: #6B7280; }

                /* Inputs for Custom Modal */
                .custom-input { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #6EE7B7; margin-bottom: 1rem; font-size: 1rem; outline: none; transition: border-color 0.2s; }
                .custom-input:focus { border-color: #059669; box-shadow: 0 0 0 2px #D1FAE5; }
                .custom-label { display: block; text-align: left; font-size: 0.9rem; font-weight: 700; color: #064E3B; margin-bottom: 0.5rem; }
                .custom-btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
                .custom-btn-group .modal-btn { flex: 1; min-width: 100px; }

                /* Start Screen Specific */
                #start-modal .modal-content { border-width: 4px; padding-top: 2rem; padding-bottom: 2rem; }

                .install-guide-icon { margin-bottom: 10px; color: #059669; }
                .install-step { text-align: left; font-size: 0.9rem; margin-bottom: 12px; display: flex; align-items: flex-start; gap: 8px; color: #374151; line-height: 1.4; }
                .step-num { background: #10B981; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0.75rem; font-weight: bold; margin-top: 2px; }

                /* ä¿®æ­£ï¼šç›®æ¨™æ¬„ä½æ¨£å¼ */
                .footer-panel { 
                    margin-top: 1rem; 
                    background-color: white; 
                    padding: 1rem; 
                    border-radius: 1.25rem; /* å››å‘¨åœ“è§’ */
                    border: 2px solid #6EE7B7; /* å®Œæ•´é‚Šæ¡† */
                    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
                    width: 100%; 
                }
                
                .target-tags-wrapper { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
                .target-tag { display: inline-flex; align-items: center; justify-content: center; padding: 0.375rem 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; transition: all 0.3s; border: 1px solid transparent; background-color: #ECFDF5; color: #064E3B; }
                .target-tag.found { background-color: #6EE7B7; opacity: 0.6; position: relative; text-decoration: line-through; color: #064E3B; }
                
                .site-footer { width: 100%; text-align: center; padding: 1.5rem 0 0.5rem; font-size: 0.875rem; color: #064E3B; opacity: 0.8; font-weight: 500; display: flex; justify-content: center; align-items: center; border-top: 1px dashed #6EE7B7; margin-top: 1rem; flex-direction: column; gap: 4px; }
                .site-footer a { color: #059669; text-decoration: none; margin-left: 6px; font-weight: 700; }
                .visitor-counter { font-size: 0.8rem; background-color: #ECFDF5; padding: 2px 8px; border-radius: 10px; color: #059669; display: inline-flex; align-items: center; gap: 4px; }
                
                @keyframes bounceIn { 0% { transform: scale(0.8); opacity: 0; } 60% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
                @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
                @keyframes pop { 0% { transform: scale(0.8); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
            `;

            const styleEl = document.createElement('style');
            styleEl.textContent = styles;
            shadow.appendChild(styleEl);

            // --- 4. èª²ç¨‹è³‡æ–™ (L1-L12) ---
            const STAGES = {
                L2_01: { id: 'L2_01', name: 'ç¬¬ä¸€èª² æ–°åŒå­¸', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè© ', gridSize: 11, directions: [[0, 1], [1, 0], [1, 1]], words: ['æ¯”è¼ƒ' ,'å¤§å®¶','æ–¹å‹æœ‹','é«˜èˆˆ','è·Ÿ','æ­¡è¿','ä»Šå¹´','ä»‹ç´¹','è‡ªå·±','çœ‹æ›¸','èªè­˜','ç¾åœ¨','æ–°','å­¸','æ¸¸æ³³','æœ€','è¯èª','å¼µè‰'], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_02: { id: 'L2_02', name: 'ç¬¬äºŒèª² æˆ‘çˆ¸çˆ¸åšç”Ÿæ„', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè© ', gridSize: 11, directions: [[0, 1], [1, 0], [1, 1]], words: ['å¹«' ,'é›»è…¦å…¬å¸' ,'å·¥ä½œ' ,'ä¸Šç­' ,'å¤–å…¬' ,'å¤–å©†' ,'ä¸€æ¨£' ,'ä»¥å‰','ä»¥å¾Œ' ,'éŠ€è¡Œ' ,'é†«ç”Ÿ' ,'åšç”Ÿæ„'], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_03: { id: 'L2_03', name: 'ç¬¬ä¸‰èª² å»è¶…ç´šå¸‚å ´', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè©', gridSize: 11, directions: [[0, 1], [1, 0], [1, 1]], words: ['å†°æ·‡æ·‹' ,'è¶…ç´šå¸‚å ´' ,'æ±è¥¿' ,'é™„è¿‘' ,'å¯ä»¥' ,'ç±³' ,'è²·' ,'ç‰›è‚‰' ,'å·§å…‹åŠ›' ,'é’èœ' ,'ç³–æœ' ,'è¦' ,'é­š'], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_04: { id: 'L2_04', name: 'ç¬¬å››èª² æˆ‘æƒ³åƒæ¼¢å ¡', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè©', gridSize: 11, directions: [[0, 1], [1, 0], [1, 1]], words: ['å‡ºå»' ,'è›‹ç‚’é£¯' ,'é¤“' ,'æ¼¢å ¡' ,'å¿«é»' ,'äº†' ,'éºµ' ,'è–¯æ¢' ,'æ¹¯' ,'æ™šé¤','æ™šé£¯' ,'å…ˆ' ,'å·²ç¶“' ,'ç‰ç±³' ,'å†' ,'é€±æœ«'], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_05: { id: 'L2_05', name: 'ç¬¬äº”èª² ç§‹å¤©å¿«åˆ°äº†', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè© ', gridSize: 12, directions: [[0, 1], [1, 0], [1, 1]], words: ['è®Š' ,'ä¸éŒ¯' ,'ç™½è‰²' ,'æ˜¥å¤©' ,'è‰' ,'ç´…è‰²' ,'é»ƒ' ,'é‚„æ˜¯' ,'èŠ±' ,'äº†' ,'ç¶ è‰²' ,'æ¼‚äº®' ,'ç§‹å¤©' ,'æ™‚å€™' ,'æ¨¹è‘‰' ,'å¤©æ°£' ,'é™¢å­' ,'é¡è‰²' ,'èˆ’æœ'], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_06: { id: 'L2_06', name: 'ç¬¬å…­èª² è¾²æ›†æ–°å¹´', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè© ', gridSize: 11, directions: [[0, 1], [1, 0], [1, 1]], words: ['æ‹œå¹´' ,'æ”¾é­ç‚®' ,'çµ¦' ,'ç´…åŒ…' ,'æœƒ' ,'æ¯æ¬¡' ,'é‚£å¤©' ,'å¹´ç³•' ,'å¦‚æœ' ,'èªª' ,'è‡ºç£' ,'è²¼æ˜¥è¯' ,'æ–°å¹´' ,'æ”¾' ,'æ˜ŸæœŸ' ,'è¯äºº','è¾²æ›†' ], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_07: { id: 'L2_07', name: 'ç¬¬ä¸ƒèª² æ—©ä¸€é»ç¡è¦º', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè©', gridSize: 12, directions: [[0, 1], [1, 0], [1, 1]], words: ['åˆ¥' ,'è‚¥çš‚' ,'ä¹¾æ·¨' ,'è©²' ,'é' ,'è¶•å¿«' ,'ä¾†ä¸åŠ' ,'ç´¯' ,'èµ·åºŠ' ,'åˆ·ç‰™' ,'ç¡è¦º' ,'æ™šä¸Š' ,'å¿˜' ,'æ´—' ,'æ´—æ¾¡' ,'æ´—è‡‰' ,'ç”¨' ,'çŸ¥é“' ,'æ˜¨å¤©' ], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_08: { id: 'L2_08', name: 'ç¬¬å…«èª² æˆ‘çš„å¯µç‰©', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè©', gridSize: 11, directions: [[0, 1], [1, 0], [1, 1]], words: ['ä¸è¦‹äº†' ,'å¯µç‰©' ,'å¸¶' ,'éå¸¸' ,'é','ç‹—' ,'å¯æ„›' ,'è²“' ,'å»å¹´' ,'é€çµ¦' ,'ä¸Šå€‹æœˆ' ,'ç‰ å€‘' ,'å…”å­' ,'é¤µ' ,'é¤Š' ,'éš»' ,'æ•£æ­¥'], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_09: { id: 'L2_09', name: 'ç¬¬ä¹èª² éŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè©', gridSize: 11, directions: [[0, 1], [1, 0], [1, 1]], words: ['åŒ—æ–¹' ,'é‚„æ˜¯','æ±æ–¹' ,'æ–¹å‘' ,'å‘Šè¨´' ,'æ•™å®¤' ,'å—æ–¹' ,'æ‰€ä»¥' ,'å®ƒ' ,'æ ¡é–€å£' ,'è¥¿æ–¹' ,'å› ç‚º' ,'è¶³çƒå ´' ,'æŒ‡åŒ—é‡' ,'æŒ‡å—é‡'], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_10: { id: 'L2_10', name: 'ç¬¬åèª² å¤–å…¬ã€å¤–å©†ä½åœ¨è‡ºç£', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè©', gridSize: 11, directions: [[0, 1], [1, 0], [1, 1]], words: ['æœ¬ä¾†' ,'æ³•åœ‹' ,'èˆ…èˆ…' ,'çœ‹' ,'æ—…è¡Œ' ,'ç´ç´„' ,'è‡ºåŒ—' ,'è‡ºå—' ,'é€€ä¼‘' ,'ä¸€æ¬¡' ,'ä½åœ¨' ,'æš‘å‡'], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_11: { id: 'L2_11', name: 'ç¬¬åä¸€èª² å»å‹•ç‰©åœ’', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè©', gridSize: 11, directions: [[0, 1], [1, 0], [1, 1]], words: ['ä¸ä½†' ,'è„–å­' ,'é•·é ¸é¹¿' ,'å¤§è±¡' ,'å‹•ç‰©åœ’' ,'çŒ´å­' ,'çœ‹åˆ°' ,'è€è™' ,'èƒ–' ,'ä¼éµ' ,'ç©' ,'ç†Šè²“' ,'å¸Œæœ›' ,'é€™ä¸€æ¬¡' ,'é•·' ,'çœŸ'], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' },
                L2_12: { id: 'L2_12', name: 'ç¬¬åäºŒèª² æ‰“ç¶²è·¯é›»è©±', description: 'æ‰¾å‡ºæœ¬èª²çš„ç”Ÿè©', gridSize: 11, directions: [[0, 1], [1, 0], [1, 1]], words: ['å•Š' ,'éä¾†' ,'å¾ˆä¹…' ,'å¥½å¥½' ,'çœ‹èµ·ä¾†' ,'æ²’å•é¡Œ' ,'ä¸Šèª²' ,'èªªè©±' ,'ç˜¦' ,'ç¶²è·¯' ,'å¯«' ,'ä¿¡' ,'æœ‰æ„æ€' ,'ä¸€å®š','å½±åƒ' ,'é•·é«˜','é›»è©±' ], targetCount: 99, brainTip: 'Sophia Wong ä¿®è¨‚' }
            };

            const EXTRA_FILLERS = 'é™³å¿ƒç¾å«æå¤§æ–‡æ—æ±æ˜åå­—ä½ å¥½æ˜¯ä»€éº¼ä»–æˆ‘çˆ¸çˆ¸å¼Ÿå¼Ÿå€‹å“¥å“¥å’Œå®¶å¹¾è€å¸«åª½åª½å‘¢äººå››ä¸‰äº”ç‹æœ‰å…«ç­ä¹å…­å…©ç”·ç”Ÿå¥³ç”Ÿä½ å€‘ä¸ƒååŒå­¸æˆ‘å€‘ä¹Ÿåƒæœæ±å–é‚„æœ‰é‚„è¦ä»Šå¤©ä¾†éºµåŒ…ç‰›å¥¶æ°´æœæ—©é£¯ å†¬å¤©å¾ˆè¦ºå¾—å¯æ˜¯å†·ç†±å¤ªäº†å–œæ­¡å¤å¤©æœ‰ä¸€é»åˆ°çš„è›‹ç³•äºŒåå…«å¥½å¿«ç¦®ç‰©æ¼«ç•«ç”Ÿæ—¥åä¸€æ›¸ä¸‰åç©å…·æœˆé¼»å­å§å¤§ç•«åœ–æœƒçœ‹å—èº«é«”æ‰‹é ­é›ªäººå°ä¸€èµ·çœ¼ç›å”±æ­Œå¸¸å¸¸æ‰“çƒå¥½çœ‹é›»è¦–è·‘æ­¥è·³èˆè½éŸ³æ¨‚ä¸‹èª²ä»¥å¾Œåšéƒ½æˆ¿é–“å¾Œé¢è£¡é¢æ²’æœ‰å“ªè£¡å»æ²™ç™¼ä¸Šé¢ä¸‹é¢ä¸€ä¸‹åœ¨æ‰¾æ¡Œå­å°ä¸å°å§‘å§‘é‚£æ™‚å€™å¥¶å¥¶å”å”èª°ä»–å€‘å°å­©çˆºçˆºå³é‚Šä¸­é–“å·¦é‚Šç…§ç‰‡å¼µé€™æ­²'; 
            
            // é¼“å‹µèªéŒ„
            const ENCOURAGEMENTS = [
                "å¤ªæ£’äº†ï¼", "çœŸå²å®³ï¼", "åšå¾—å¥½ï¼", "æŒ‘æˆ°æˆåŠŸï¼", "çœ¼åŠ›çœŸå¥½ï¼", "åæ‡‰è¶…å¿«ï¼", "ä½ æ˜¯æ‰¾å­—é«˜æ‰‹ï¼", "å®Œç¾éé—œï¼", "å¤ªç¥äº†ï¼"
            ];

            const allUniqueChars = new Set(EXTRA_FILLERS.replace(/\s+/g, '').split(''));
            Object.values(STAGES).forEach(stage => {
                if (stage.words) {
                    stage.words.forEach(word => {
                        for (const char of word) {
                            if (char >= '\u4e00' && char <= '\u9fa5') allUniqueChars.add(char);
                        }
                    });
                }
            });
            const COMMON_CHARS = Array.from(allUniqueChars);

            const svgs = {
                brain: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#10B981"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>',
                print: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>',
                info: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
                eye: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>',
                refresh: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>',
                trophy: '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#10B981; margin:0 auto 8px"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>',
                fullscreen: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M16 3h3a2 2 0 0 1 2 2v3"/><path d="M8 21H5a2 2 0 0 1-2-2v-3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>',
                exitFullscreen: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14h6v6"/><path d="M20 14h-6v6"/><path d="M14 4h6v6"/><path d="M10 4H4v6"/></svg>',
                download: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="14" x="8" y="2" rx="2"/><path d="M12 18h.01"/><path d="M11 2h2"/></svg>',
                bookmark: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>',
                iosShare: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>',
                menuDots: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>',
                plusSquare: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>',
                rocket: '<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color:#10B981; margin-bottom:1rem;"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>',
                edit: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
                copy: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>'
            };

            let state = {
                stage: STAGES.L2_01,
                board: [], targets: [], foundWords: [], firstSelection: null, selection: [], deferredPrompt: null,
                startTime: 0, timerInterval: null, gameStarted: false, wakeLock: null
            };

            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); state.deferredPrompt = e; });

            // --- DOM ---
            const container = document.createElement('div');
            container.className = 'game-container';
            container.innerHTML = `
                <div class="inner-wrapper">
                    <header>
                        <div class="title-group">
                            ${svgs.brain} 
                            <div style="display: flex; flex-direction: column;">
                                <h1>ç”Ÿè©å¤§æŒ‘æˆ°</h1>
                                <span class="subtitle">å­¸è¯èªå‘å‰èµ°ç¬¬äºŒå†Š</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <button class="icon-btn" id="btn-custom" title="è‡ªè¨‚ç”Ÿè©">${svgs.edit}</button>
                            <button class="icon-btn" id="btn-print" title="åˆ—å°">${svgs.print}</button>
                            <button class="icon-btn" id="btn-install" title="åŠ å…¥/æ›¸ç±¤">${svgs.download}</button>
                            <button class="icon-btn" id="btn-fullscreen" title="å…¨è¢å¹•">${svgs.fullscreen}</button>
                        </div>
                    </header>

                    <div class="controls">
                        <div class="select-wrapper">
                            <label class="select-label">é¸æ“‡èª²ç¨‹</label>
                            <select id="stage-select">
                                ${Object.keys(STAGES).map(k => `<option value="${k}">${STAGES[k].name}</option>`).join('')}
                            </select>
                        </div>
                        <div id="timer-display" class="timer-badge">00:00</div>
                        <button class="refresh-btn" id="btn-refresh">${svgs.refresh}</button>
                    </div>

                    <div class="desc-text" id="desc-text"></div>
                    <div style="text-align:center; font-size:0.8rem; color:#10B981; margin-bottom: 0.5rem; width:100%;">ğŸ’¡ é»æ“Šã€Œå­—é¦–ã€èˆ‡ã€Œå­—å°¾ã€å³å¯é€£ç·š</div>

                    <div class="game-area">
                        <div class="grid-container" id="grid-container"></div>
                        
                        <!-- æº–å‚™é–‹å§‹ç•«é¢ -->
                        <div class="modal-overlay show" id="start-modal" style="background-color: rgba(240, 253, 244, 0.95);">
                            <div class="modal-content">
                                ${svgs.rocket}
                                <h2 style="font-size: 1.5rem; font-weight: 700; color: #064E3B; margin-bottom: 0.5rem;">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
                                <p style="font-size: 1rem; color: #064E3B; opacity: 0.8; margin-bottom: 1.5rem;">æ‰¾å‡ºæ‰€æœ‰ç”Ÿè©ï¼ŒæŒ‰ä¸‹æŒ‰éˆ•é–‹å§‹è¨ˆæ™‚ï¼</p>
                                <button class="modal-btn" id="btn-game-start" style="font-size: 1.1rem; padding: 0.75rem 2rem;">é–‹å§‹éŠæˆ²</button>
                            </div>
                        </div>

                        <!-- å‹åˆ©è¦–çª— -->
                        <div class="modal-overlay" id="victory-modal">
                            <div class="modal-content">
                                ${svgs.trophy}
                                <h2 style="font-size: 1.25rem; font-weight: 700; color: #064E3B; margin-bottom: 4px;" id="victory-title">å¤ªæ£’äº†ï¼</h2>
                                <p style="font-size: 0.875rem; color: #064E3B; opacity: 0.8; margin-bottom: 0.5rem;">å…¨éƒ¨ç”Ÿè©éƒ½æ‰¾åˆ°äº†ï¼</p>
                                <p style="font-size: 1rem; color: #059669; font-weight: bold; margin-bottom: 1rem;">è€—æ™‚ï¼š<span id="final-time">00:00</span></p>
                                <button class="modal-btn" id="btn-copy-result" style="background-color: #3B82F6; margin-bottom: 8px;">${svgs.copy} è¤‡è£½æˆç¸¾</button>
                                <button class="modal-btn" id="btn-replay">å†ç©ä¸€æ¬¡</button>
                            </div>
                        </div>
                    </div>

                    <div class="footer-panel">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px;">
                            <h4 style="font-size: 0.875rem; font-weight: 700; color: #064E3B; margin: 0;">
                                ç›®æ¨™ (<span id="found-count">0</span>/<span id="total-count">0</span>)
                            </h4>
                            <span style="font-size: 0.75rem; opacity: 0.6;" id="direction-hint"></span>
                        </div>
                        <div class="target-tags-wrapper" id="target-list"></div>
                    </div>

                    <footer class="site-footer">
                        <div>Sophia Wong ä¿®è¨‚</div>
                        <div class="visitor-counter">
                            ğŸ”¥ ç´¯ç©äººæ¬¡ï¼š<span id="visitor-count-display">...</span>
                        </div>
                    </footer>

                    <!-- è‡ªè¨‚ç”Ÿè©è¦–çª— -->
                    <div class="modal-overlay" id="custom-modal">
                        <div class="modal-content" style="text-align: left; width: 90%; max-width: 400px;">
                            <button class="modal-close-btn" id="btn-close-custom">Ã—</button>
                            <h3 id="custom-modal-title" style="margin:0 0 1rem; color:#064E3B; text-align:center;">è‡ªè¨‚ç”Ÿè©</h3>
                            
                            <label class="custom-label">æ¨™é¡Œ</label>
                            <input type="text" id="custom-title" class="custom-input" value="æˆ‘çš„ç”Ÿè©è¡¨" placeholder="è¼¸å…¥èª²ç¨‹æ¨™é¡Œ">
                            
                            <label class="custom-label">ç”Ÿè©åˆ—è¡¨ (æ›è¡Œæˆ–é€—è™Ÿåˆ†éš”)</label>
                            <textarea id="custom-words" class="custom-input" rows="5" placeholder="ä¾‹å¦‚ï¼š&#10;è˜‹æœ&#10;é¦™è•‰&#10;è¥¿ç“œ"></textarea>
                            
                            <!-- éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºå€ (å–ä»£ alert) -->
                            <div id="custom-error-msg" style="color:#EF4444; font-size:0.9rem; margin-bottom:10px; text-align:center; display:none;"></div>

                            <div class="custom-btn-group">
                                <button class="modal-btn" id="btn-start-custom">å»ºç«‹ä¸¦é–‹å§‹</button>
                            </div>
                            <div class="custom-btn-group" id="edit-buttons-row" style="display:none; margin-top:10px;">
                                <button class="modal-btn secondary" id="btn-new-custom">å»ºç«‹æ–°çš„</button>
                                <button class="modal-btn danger" id="btn-delete-custom">åˆªé™¤æ­¤èª²ç¨‹</button>
                            </div>
                        </div>
                    </div>

                    <!-- å®‰è£/æ›¸ç±¤æ•™å­¸ -->
                    <div class="modal-overlay" id="install-modal">
                        <div class="modal-content" style="text-align:left;">
                            <button class="modal-close-btn" id="btn-close-install">Ã—</button>
                            <div style="text-align:center; margin-bottom:10px;">
                                <div class="install-guide-icon">${svgs.download}</div>
                                <h3 style="margin:0; color:#064E3B;">åŠ å…¥ä¸»ç•«é¢</h3>
                                <p style="font-size:0.8rem; color:#666; margin:5px 0 15px;">å°‡éŠæˆ²è®Šæˆ Appï¼Œå…¨è¢å¹•é«”é©—æ›´å¥½ï¼</p>
                            </div>
                            <div id="install-instructions"></div>
                        </div>
                    </div>
                </div>
            `;
            shadow.appendChild(container);

            const ui = {
                grid: shadow.querySelector('#grid-container'),
                stageSelect: shadow.querySelector('#stage-select'),
                btnRefresh: shadow.querySelector('#btn-refresh'),
                btnReplay: shadow.querySelector('#btn-replay'),
                btnPrint: shadow.querySelector('#btn-print'),
                btnFullscreen: shadow.querySelector('#btn-fullscreen'),
                btnInstall: shadow.querySelector('#btn-install'),
                btnCloseInstall: shadow.querySelector('#btn-close-install'),
                installModal: shadow.querySelector('#install-modal'),
                installInstructions: shadow.querySelector('#install-instructions'),
                brainTip: shadow.querySelector('#brain-tip-text'),
                descText: shadow.querySelector('#desc-text'),
                dirHint: shadow.querySelector('#direction-hint'),
                modal: shadow.querySelector('#victory-modal'),
                startModal: shadow.querySelector('#start-modal'),
                btnGameStart: shadow.querySelector('#btn-game-start'),
                foundCount: shadow.querySelector('#found-count'),
                totalCount: shadow.querySelector('#total-count'),
                targetList: shadow.querySelector('#target-list'),
                timerDisplay: shadow.querySelector('#timer-display'),
                finalTime: shadow.querySelector('#final-time'),
                victoryTitle: shadow.querySelector('#victory-title'),
                visitorCountDisplay: shadow.querySelector('#visitor-count-display'),
                btnCopyResult: shadow.querySelector('#btn-copy-result'),
                
                // Custom UI
                btnCustom: shadow.querySelector('#btn-custom'),
                customModal: shadow.querySelector('#custom-modal'),
                btnCloseCustom: shadow.querySelector('#btn-close-custom'),
                btnStartCustom: shadow.querySelector('#btn-start-custom'),
                customTitle: shadow.querySelector('#custom-title'),
                customWords: shadow.querySelector('#custom-words'),
                editButtonsRow: shadow.querySelector('#edit-buttons-row'),
                btnDeleteCustom: shadow.querySelector('#btn-delete-custom'),
                btnNewCustom: shadow.querySelector('#btn-new-custom'),
                customModalTitle: shadow.querySelector('#custom-modal-title'),
                customErrorMsg: shadow.querySelector('#custom-error-msg')
            };

            // --- Helper: Format Time ---
            function formatTime(seconds) {
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }

            // --- Wake Lock Logic ---
            async function requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        state.wakeLock = await navigator.wakeLock.request('screen');
                    }
                } catch (err) {
                    console.log(`${err.name}, ${err.message}`);
                }
            }

            function releaseWakeLock() {
                if (state.wakeLock !== null) {
                    state.wakeLock.release()
                        .then(() => { state.wakeLock = null; });
                }
            }

            // Game Logic
            function startTimer() {
                if (state.timerInterval) clearInterval(state.timerInterval);
                state.startTime = Date.now();
                ui.timerDisplay.textContent = "00:00";
                
                state.timerInterval = setInterval(() => {
                    const elapsed = (Date.now() - state.startTime) / 1000;
                    ui.timerDisplay.textContent = formatTime(elapsed);
                }, 1000);
            }

            function stopTimer() {
                if (state.timerInterval) {
                    clearInterval(state.timerInterval);
                    state.timerInterval = null;
                }
            }

            function generateBoard(stageConfig) {
                const size = stageConfig.gridSize;
                const board = Array(size).fill(null).map(() => Array(size).fill(''));
                const targets = [];
                let itemsToPlace = [...stageConfig.words].sort(() => 0.5 - Math.random());
                const itemsToPlaceSet = new Set(itemsToPlace);

                for (const item of itemsToPlace) {
                    let placed = false;
                    let attempts = 0;
                    const chars = [...item];
                    while (!placed && attempts < 200) { 
                        attempts++;
                        const direction = stageConfig.directions[Math.floor(Math.random() * stageConfig.directions.length)];
                        const [dr, dc] = direction;
                        const startR = Math.floor(Math.random() * size), startC = Math.floor(Math.random() * size);
                        const endR = startR + dr * (chars.length - 1), endC = startC + dc * (chars.length - 1);
                        if (endR < 0 || endR >= size || endC < 0 || endC >= size) continue;
                        let canPlace = true;
                        for (let i = 0; i < chars.length; i++) {
                            const r = startR + dr * i, c = startC + dc * i;
                            if (board[r][c] !== '' && board[r][c] !== chars[i]) { canPlace = false; break; }
                        }
                        if (canPlace) {
                            for (let i = 0; i < chars.length; i++) board[startR + dr * i][startC + dc * i] = chars[i];
                            targets.push({ word: item, found: false, start: [startR, startC], end: [endR, endC] });
                            placed = true;
                        }
                    }
                }
                let fillerPool = COMMON_CHARS.filter(i => !itemsToPlaceSet.has(i));
                if (!fillerPool || fillerPool.length === 0) fillerPool = ['ç©º'];
                for (let r = 0; r < size; r++) for (let c = 0; c < size; c++) if (board[r][c] === '') board[r][c] = fillerPool[Math.floor(Math.random() * fillerPool.length)];
                return { board, targets };
            }

            function initGame(stageKey = 'L2_01') {
                state.stage = STAGES[stageKey];
                const data = generateBoard(state.stage);
                state.board = data.board;
                state.targets = data.targets;
                state.foundWords = [];
                state.firstSelection = null; 
                state.gameStarted = false; // Reset game started flag
                
                ui.stageSelect.value = stageKey;
                ui.descText.textContent = state.stage.description;
                ui.dirHint.textContent = 'å¯ç›´ã€æ©«ã€æ–œå‘å°‹æ‰¾';
                ui.modal.classList.remove('show');
                
                // Show start modal
                ui.startModal.classList.add('show');
                
                // Reset timer display
                stopTimer();
                ui.timerDisplay.textContent = "00:00";
                
                renderGrid();
                renderTargets();
            }

            function renderGrid() {
                ui.grid.style.gridTemplateColumns = `repeat(${state.stage.gridSize}, minmax(0, 1fr))`;
                let html = '';
                for (let r = 0; r < state.stage.gridSize; r++) {
                    for (let c = 0; c < state.stage.gridSize; c++) {
                        const isStart = state.firstSelection && state.firstSelection.r === r && state.firstSelection.c === c;
                        let isFound = false;
                        for (const t of state.targets) {
                            if (state.foundWords.includes(t.word)) {
                                const [sr, sc] = t.start;
                                const [er, ec] = t.end;
                                const dr = Math.sign(er - sr);
                                const dc = Math.sign(ec - sc);
                                const len = Math.max(Math.abs(er - sr), Math.abs(ec - sc)) + 1;
                                for(let i=0; i<len; i++) {
                                    if (sr + i*dr === r && sc + i*dc === c) { isFound = true; break; }
                                }
                            }
                            if (isFound) break;
                        }
                        let className = 'cell';
                        if (state.stage.isIconMode) className += ' icon-mode';
                        if (isStart) className += ' active-start';
                        else if (isFound) className += ' found';
                        html += `<div class="${className}" data-r="${r}" data-c="${c}">${state.board[r][c]}</div>`;
                    }
                }
                ui.grid.innerHTML = html;
            }

            function renderTargets() {
                ui.foundCount.textContent = state.foundWords.length;
                ui.totalCount.textContent = state.targets.length;
                const list = ui.targetList;
                list.innerHTML = state.targets.map(t => {
                    const isFound = state.foundWords.includes(t.word);
                    let cls = 'target-tag';
                    if (isFound) cls += ' found';
                    return `<span class="${cls}">${t.word}</span>`;
                }).join('');
            }

            function handleCellClick(r, c) {
                // Prevent interaction if game hasn't started
                if (!state.gameStarted) return; 

                if (!state.firstSelection) {
                    state.firstSelection = { r, c };
                    renderGrid();
                    return;
                }
                const start = state.firstSelection;
                if (start.r === r && start.c === c) {
                    const char = state.board[r][c];
                    const matchedTarget = state.targets.find(t => !state.foundWords.includes(t.word) && t.word === char);
                    if (matchedTarget) {
                        state.foundWords.push(matchedTarget.word);
                        checkVictory();
                        state.firstSelection = null;
                    } else {
                        state.firstSelection = null;
                    }
                    renderGrid(); renderTargets(); return;
                }
                
                // Logic for multi-character selection
                const dr = r - start.r;
                const dc = c - start.c;
                const isDiagonal = Math.abs(dr) === Math.abs(dc);
                const isHorizontal = dr === 0;
                const isVertical = dc === 0;

                if (isHorizontal || isVertical || isDiagonal) {
                    const steps = Math.max(Math.abs(dr), Math.abs(dc));
                    const rStep = dr === 0 ? 0 : dr / steps;
                    const cStep = dc === 0 ? 0 : dc / steps;
                    let selectedWord = '';
                    for (let i = 0; i <= steps; i++) {
                        const currR = start.r + i * rStep;
                        const currC = start.c + i * cStep;
                        selectedWord += state.board[currR][currC];
                    }
                    const matchedTarget = state.targets.find(t => 
                        !state.foundWords.includes(t.word) && 
                        (t.word === selectedWord || t.word === [...selectedWord].reverse().join(''))
                    );
                    if (matchedTarget) {
                        state.foundWords.push(matchedTarget.word);
                        checkVictory();
                    }
                }
                state.firstSelection = null;
                renderGrid();
                renderTargets();
            }

            function checkVictory() {
                if (state.foundWords.length === state.targets.length) {
                    stopTimer(); 
                    releaseWakeLock(); // Release lock
                    ui.finalTime.textContent = ui.timerDisplay.textContent;
                    // Random encouragement
                    const randomMsg = ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)];
                    ui.victoryTitle.textContent = randomMsg;
                    setTimeout(() => ui.modal.classList.add('show'), 300);
                }
            }

            ui.grid.addEventListener('click', e => {
                const el = e.target.closest('.cell');
                if (el) handleCellClick(parseInt(el.dataset.r), parseInt(el.dataset.c));
            });

            // Start Game Button Logic
            ui.btnGameStart.addEventListener('click', () => {
                state.gameStarted = true;
                ui.startModal.classList.remove('show');
                requestWakeLock(); // Request screen keep awake
                startTimer();
            });

            ui.btnCopyResult.addEventListener('click', () => {
                const text = `ç”Ÿè©å¤§æŒ‘æˆ° - ${state.stage.name}\n${ui.victoryTitle.textContent} è€—æ™‚ï¼š${ui.finalTime.textContent}`;
                navigator.clipboard.writeText(text).then(() => {
                    const originalText = ui.btnCopyResult.innerHTML;
                    ui.btnCopyResult.innerHTML = "å·²è¤‡è£½ï¼";
                    setTimeout(() => ui.btnCopyResult.innerHTML = originalText, 2000);
                });
            });

            ui.stageSelect.addEventListener('change', (e) => initGame(e.target.value));
            ui.btnRefresh.addEventListener('click', () => initGame(state.stage.id));
            ui.btnReplay.addEventListener('click', () => initGame(state.stage.id));
            ui.btnFullscreen.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.getElementById('huayu-book2-root').requestFullscreen().catch(err => alert(`Error: ${err.message}`));
                    ui.btnFullscreen.innerHTML = svgs.exitFullscreen;
                } else {
                    document.exitFullscreen();
                    ui.btnFullscreen.innerHTML = svgs.fullscreen;
                }
            });
            document.addEventListener('fullscreenchange', () => {
                 ui.btnFullscreen.innerHTML = !document.fullscreenElement ? svgs.fullscreen : svgs.exitFullscreen;
            });
            ui.btnPrint.addEventListener('click', () => {
                const printWindow = window.open('', '_blank');
                if (!printWindow) { alert("è«‹å…è¨±å½ˆè·³è¦–çª—"); return; }
                const html = `<!DOCTYPE html><html><head><title>è…¦åŠ›æ‰¾å­—éŠæˆ²</title><style>@page { size: auto; margin: 5mm; } body { font-family: sans-serif; text-align: center; } .grid { display: grid; grid-template-columns: repeat(${state.stage.gridSize}, 1fr); border: 2px solid #333; width: 100%; max-width: 16cm; margin: 0 auto; } .cell { border: 1px solid #ccc; aspect-ratio: 1; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: bold; } .words { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 15px; } .word { border: 1px solid #333; padding: 4px 8px; border-radius: 4px; }</style></head><body><h1>${state.stage.name}</h1><div class="grid">${state.board.flat().map(c => `<div class="cell">${c}</div>`).join('')}</div><div class="words">${state.targets.map(t => `<div class="word">${t.word}</div>`).join('')}</div><div class="footer">Sophia Wong ä¿®è¨‚</div></body></html>`;
                printWindow.document.write(html);
                printWindow.document.close();
            });
            
            ui.btnInstall.addEventListener('click', () => {
                if (state.deferredPrompt) { 
                    state.deferredPrompt.prompt(); 
                    state.deferredPrompt = null; 
                    return; 
                }

                const ua = navigator.userAgent;
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
                const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
                const isMac = /Macintosh|Mac OS X/.test(ua);

                let title = "åŠ å…¥ä¸»ç•«é¢";
                let sub = "å°‡éŠæˆ²è®Šæˆ Appï¼Œå…¨è¢å¹•é«”é©—æ›´å¥½ï¼";
                let html = "";

                if (isMobile) {
                    if (isIOS) {
                        html = `<div class="install-step"><div class="step-num">1</div> é»æ“Šåˆ†äº« ${svgs.iosShare}</div><div class="install-step"><div class="step-num">2</div> é¸ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ ${svgs.plusSquare}</div>`;
                    } else {
                        html = `<div class="install-step"><div class="step-num">1</div> é»æ“Šç€è¦½å™¨é¸å–® ${svgs.menuDots}</div><div class="install-step"><div class="step-num">2</div> é¸æ“‡ã€Œå®‰è£ã€æˆ–ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</div>`;
                    }
                } else {
                    title = "åŠ å…¥æ›¸ç±¤";
                    sub = "æŠŠé€™å€‹éŠæˆ²å­˜ä¸‹ä¾†ï¼Œä¸‹æ¬¡æ–¹ä¾¿è¤‡ç¿’ï¼";
                    const key = isMac ? "Cmd + D" : "Ctrl + D";
                    html = `
                        <div style="text-align:center; padding: 15px 0;">
                            <div style="color:#059669; margin-bottom:10px;">${svgs.bookmark}</div>
                            <p style="margin-bottom:10px; color:#374151;">è«‹æŒ‰ä¸‹éµç›¤å¿«é€Ÿéµï¼š</p>
                            <div style="display:inline-block; background:#ECFDF5; padding:8px 16px; border-radius:8px; font-weight:bold; font-size:1.2rem; color:#059669; border:1px solid #6EE7B7;">${key}</div>
                        </div>
                    `;
                }

                const modalContent = ui.installModal.querySelector('.modal-content');
                const titleEl = modalContent.querySelector('h3');
                const descEl = modalContent.querySelector('p');
                const iconEl = modalContent.querySelector('.install-guide-icon');
                
                if(titleEl) titleEl.textContent = title;
                if(descEl) descEl.textContent = sub;
                if(iconEl) iconEl.innerHTML = isMobile ? svgs.download : svgs.bookmark;
                
                ui.installInstructions.innerHTML = html;
                ui.installModal.classList.add('show');
            });
            ui.btnCloseInstall.addEventListener('click', () => ui.installModal.classList.remove('show'));


            // --- LocalStorage Logic ---
            const STORAGE_KEY = 'huayu_book2_custom_stages_v2';

            function loadCustomStages() {
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        const customs = JSON.parse(stored);
                        Object.keys(customs).forEach(key => {
                            STAGES[key] = customs[key];
                            // Add to select if not exists
                            if (!ui.stageSelect.querySelector(`option[value="${key}"]`)) {
                                const option = document.createElement('option');
                                option.value = key;
                                option.text = `â˜… ${customs[key].name}`;
                                ui.stageSelect.add(option);
                            }
                        });
                    }
                } catch (e) {
                    console.error("Failed to load custom stages", e);
                }
            }

            function saveCustomStages() {
                const customs = {};
                Object.keys(STAGES).forEach(key => {
                    if (STAGES[key].isCustom) {
                        customs[key] = STAGES[key];
                    }
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(customs));
            }


            // --- Custom Modal Logic ---
            
            // Helper to show error
            function showCustomError(msg) {
                ui.customErrorMsg.textContent = msg;
                ui.customErrorMsg.style.display = 'block';
                setTimeout(() => {
                    ui.customErrorMsg.style.display = 'none';
                }, 3000);
            }

            ui.btnCustom.addEventListener('click', () => {
                const currentId = state.stage.id;
                // Check if current is custom
                if (STAGES[currentId] && STAGES[currentId].isCustom) {
                    // Edit Mode
                    ui.customModalTitle.textContent = "ä¿®æ”¹è‡ªè¨‚ç”Ÿè©";
                    ui.customTitle.value = STAGES[currentId].name;
                    ui.customWords.value = STAGES[currentId].words.join('\n');
                    ui.btnStartCustom.textContent = "æ›´æ–°ä¸¦é–‹å§‹";
                    ui.editButtonsRow.style.display = 'flex';
                } else {
                    // Create Mode
                    ui.customModalTitle.textContent = "è‡ªè¨‚ç”Ÿè©";
                    ui.customTitle.value = "æˆ‘çš„ç”Ÿè©è¡¨";
                    ui.customWords.value = "";
                    ui.btnStartCustom.textContent = "å»ºç«‹ä¸¦é–‹å§‹";
                    ui.editButtonsRow.style.display = 'none';
                }
                ui.customModal.classList.add('show');
            });

            ui.btnCloseCustom.addEventListener('click', () => {
                // Reset delete state when closing
                deleteConfirmation = false;
                ui.btnDeleteCustom.classList.remove('confirming');
                ui.btnDeleteCustom.textContent = "åˆªé™¤æ­¤èª²ç¨‹";
                ui.customModal.classList.remove('show');
            });

            // Create New from Edit Mode
            ui.btnNewCustom.addEventListener('click', () => {
                ui.customModalTitle.textContent = "è‡ªè¨‚ç”Ÿè©";
                ui.customTitle.value = "æˆ‘çš„ç”Ÿè©è¡¨";
                ui.customWords.value = "";
                ui.btnStartCustom.textContent = "å»ºç«‹ä¸¦é–‹å§‹";
                ui.editButtonsRow.style.display = 'none';
            });

            // Delete Custom (No confirm() alert used)
            let deleteConfirmation = false;
            
            ui.btnDeleteCustom.addEventListener('click', () => {
                if (!deleteConfirmation) {
                    // First click: Request confirmation
                    deleteConfirmation = true;
                    ui.btnDeleteCustom.textContent = "ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ(é»æ“Š)";
                    ui.btnDeleteCustom.classList.add('confirming');
                    
                    // Reset after 3 seconds if not clicked
                    setTimeout(() => {
                        deleteConfirmation = false;
                        if(ui.btnDeleteCustom) {
                            ui.btnDeleteCustom.textContent = "åˆªé™¤æ­¤èª²ç¨‹";
                            ui.btnDeleteCustom.classList.remove('confirming');
                        }
                    }, 3000);
                    return;
                }

                // Second click: Perform Delete
                const currentId = state.stage.id;
                delete STAGES[currentId];
                const option = ui.stageSelect.querySelector(`option[value="${currentId}"]`);
                if (option) option.remove();
                
                saveCustomStages();
                initGame('L2_01'); // Back to default
                
                // Reset UI state
                deleteConfirmation = false;
                ui.btnDeleteCustom.textContent = "åˆªé™¤æ­¤èª²ç¨‹";
                ui.btnDeleteCustom.classList.remove('confirming');
                ui.customModal.classList.remove('show');
            });

            ui.btnStartCustom.addEventListener('click', () => {
                const title = ui.customTitle.value.trim() || 'è‡ªè¨‚èª²ç¨‹';
                const text = ui.customWords.value.trim();
                
                if (!text) {
                    showCustomError('è«‹è¼¸å…¥ç”Ÿè©ï¼');
                    return;
                }

                // Split by newline, comma, and Chinese comma
                const words = text.split(/[\n,ã€]/).map(w => w.trim()).filter(w => w.length > 0);
                
                if (words.length === 0) {
                    showCustomError('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç”Ÿè©ï¼');
                    return;
                }

                // Calculate Grid Size dynamicall based on word content
                const totalChars = words.join('').length;
                const longestWord = Math.max(...words.map(w => w.length));
                // Base calculation: sqrt(totalChars * 2.5) for enough space
                let calcSize = Math.ceil(Math.sqrt(totalChars * 2.5));
                // Ensure grid is at least bigger than the longest word (+2 padding)
                calcSize = Math.max(11, longestWord + 2, calcSize);
                // Cap at reasonable max to prevent performance issues on mobile
                calcSize = Math.min(20, calcSize);

                // Determine ID: Are we editing or creating?
                let customId;
                if (STAGES[state.stage.id] && STAGES[state.stage.id].isCustom && ui.editButtonsRow.style.display !== 'none') {
                    // Update existing
                    customId = state.stage.id;
                } else {
                    // Create new
                    customId = 'custom_' + Date.now();
                }

                STAGES[customId] = {
                    id: customId,
                    name: title,
                    description: 'è‡ªè¨‚ç”Ÿè©æŒ‘æˆ°',
                    gridSize: calcSize,
                    directions: [[0, 1], [1, 0], [1, 1]],
                    words: words,
                    targetCount: words.length,
                    brainTip: 'è‡ªè¨‚æŒ‘æˆ°',
                    isCustom: true
                };

                // Update select: if exists update text, else add
                let option = ui.stageSelect.querySelector(`option[value="${customId}"]`);
                if (option) {
                    option.text = `â˜… ${title}`;
                } else {
                    option = document.createElement('option');
                    option.value = customId;
                    option.text = `â˜… ${title}`;
                    ui.stageSelect.add(option);
                }
                
                ui.stageSelect.value = customId;
                saveCustomStages(); // Save to localStorage

                initGame(customId);
                ui.customModal.classList.remove('show');
            });


            // --- initPublicCounter: é›¶è¨­å®šå…¬å…±è¨ˆæ•¸å™¨ (Busuanzi) ---
            const initPublicCounter = () => {
                const display = ui.visitorCountDisplay;
                
                // 1. æœ¬æ©Ÿ/é è¦½ç’°å¢ƒæª¢æ¸¬ (Early Return)
                // å¦‚æœæ˜¯æœ¬æ©Ÿæª”æ¡ˆ (file:) æˆ– é è¦½ Blob (blob:)ï¼Œç›´æ¥é¡¯ç¤ºæç¤ºä¸¦åœæ­¢åŸ·è¡Œ
                if (location.protocol === 'file:' || location.protocol === 'blob:') {
                    display.textContent = "é è¦½æ¨¡å¼ (ç„¡è¨ˆæ•¸)";
                    display.style.color = '#9CA3AF'; // ç°è‰²
                    return; // <--- é—œéµä¿®æ­£ï¼šåœæ­¢å¾€ä¸‹åŸ·è¡Œ
                }

                display.textContent = "çµ±è¨ˆä¸­...";

                // 2. å»ºç«‹ DOM
                if (!document.getElementById('busuanzi_container_site_uv')) {
                    const proxyContainer = document.createElement('div');
                    proxyContainer.style.display = 'none';
                    proxyContainer.innerHTML = `<span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span></span>`;
                    document.body.appendChild(proxyContainer);
                }

                // 3. ç›£è½æ•¸å€¼è®ŠåŒ–
                const targetNode = document.getElementById('busuanzi_value_site_uv');
                if (targetNode) {
                    const observer = new MutationObserver((mutations) => {
                        if (targetNode.textContent) {
                            display.textContent = targetNode.textContent;
                            display.style.color = '#059669'; 
                        }
                    });
                    observer.observe(targetNode, { childList: true, characterData: true, subtree: true });
                }

                // 4. è¼‰å…¥è…³æœ¬ (åŠ å…¥éŒ¯èª¤è™•ç†)
                const script = document.createElement('script');
                script.async = true;
                script.src = "https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js";
                
                script.onerror = () => {
                    display.textContent = "æš«ç„¡æ•¸æ“š"; // æœå‹™é€£ä¸ä¸Šæ™‚é¡¯ç¤º
                    display.style.color = '#999';
                };

                // 5. é€¾æ™‚è™•ç†ï¼šå¦‚æœ 5 ç§’å¾Œé‚„æ˜¯ "çµ±è¨ˆä¸­..."ï¼Œæ”¹ç‚ºé¡¯ç¤º "æœå‹™é€£ç·šä¸­"
                setTimeout(() => {
                    if (display.textContent === "çµ±è¨ˆä¸­...") {
                        display.textContent = "æœå‹™é€£ç·šä¸­";
                    }
                }, 5000);

                document.head.appendChild(script);
            };
            
            loadCustomStages(); // Load saved custom stages
            initGame();
            initPublicCounter();
        }
        bootstrapGame();
    })();
</script>
</body>
</html>